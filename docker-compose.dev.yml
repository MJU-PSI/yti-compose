# This file overrides docker-compose.yml with settings for DEV environment
version: '3.9'

services:
  # TRAEFIK
  traefik:
    image: traefik:v2.9
    container_name: traefik
    command:
      - --log.level=INFO
      - --api.dashboard=true
      - --entrypoints.web.address=:80
      - --entrypoints.traefik.address=:8080
      # - --entrypoints.websecure.address=:443
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --providers.docker.swarmmode=true
      - --providers.docker.network=${PROJECT_NAME}_yti-network
    ports:
      - "80:80"
    # - "443:443"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
    deploy:
      labels:
        # Dashboard
        - "traefik.enable=true"
        # Change the host url here
        - "traefik.http.routers.traefik.rule=Host(`${PROJECT_DOMAIN}`) && PathPrefix(`/traefik`) || HeadersRegexp(`Referer`, `/traefik/`)"
        - "traefik.http.routers.traefik.service=api@internal"
        - "traefik.http.services.traefik.loadbalancer.server.port=8080"
        #- "traefik.http.routers.traefik.tls.certresolver=leresolver"
        - "traefik.http.routers.traefik.entrypoints=traefik"
        - "traefik.http.routers.traefik.middlewares=traefik-auth,traefik-stripprefix"
        - "traefik.http.middlewares.traefik-auth.basicauth.users=${TRAEFIK_AUTH}"
        - "traefik.http.middlewares.traefik-stripprefix.stripprefix.prefixes=/traefik"
    networks:
      - yti-network

  # PORTAINER
  agent:
    image: portainer/agent
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/lib/docker/volumes:/var/lib/docker/volumes
    deploy:
      mode: global
      placement:
        constraints: [ node.platform.os == linux ]
    networks:
      - yti-network

  portainer:
    image: portainer/portainer
    command: -H tcp://tasks.agent:9001 --tlsskipverify --admin-password '${PORTAINER_PASSWORD}'
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.portainer.rule=Host(`${PROJECT_DOMAIN}`) && PathPrefix(`/portainer`) || HeadersRegexp(`Referer`, `/portainer/`)"
        - "traefik.http.services.portainer.loadbalancer.server.port=9000"
        - "traefik.http.routers.portainer.entrypoints=web"
        - "traefik.http.routers.portainer.middlewares=portainer-stripprefix,portainer-redirect"
        - "traefik.http.middlewares.portainer-stripprefix.stripprefix.prefixes=/portainer"
        - "traefik.http.middlewares.portainer-redirect.redirectregex.regex=^(https?://[^/]+/[a-z0-9_-]+)$$"
        - "traefik.http.middlewares.portainer-redirect.redirectregex.replacement=$${1}/"
        - "traefik.http.middlewares.portainer-redirect.redirectregex.permanent=true"

      mode: replicated
      placement:
        constraints: [ node.role == manager ]
    networks:
      - yti-network

  # KEYCLOAK
  yti-keycloak:
    container_name: yti-keycloak
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.yti-keycloak.rule=Host(`${PROJECT_DOMAIN}`) && PathPrefix(`/keycloak`) || HeadersRegexp(`Referer`, `/keycloak/`) || PathPrefix(`/auth`)"
        - "traefik.http.services.yti-keycloak.loadbalancer.server.port=8080"
        - "traefik.http.routers.yti-keycloak.entrypoints=web"
        - "traefik.http.routers.yti-keycloak.middlewares=keycloak-stripprefix,keycloak-redirect"
        - "traefik.http.middlewares.keycloak-stripprefix.stripprefix.prefixes=/keycloak"
        - "traefik.http.middlewares.keycloak-redirect.redirectregex.regex=^(https?://[^/]+/[a-z0-9_-]+)$$"
        - "traefik.http.middlewares.keycloak-redirect.redirectregex.replacement=$${1}/"
        - "traefik.http.middlewares.keycloak-redirect.redirectregex.permanent=true"

  # GROUPMANAGEMENT
  yti-groupmanagement:
    container_name: yti-groupmanagement
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.yti-groupmanagement.rule=Host(`${PROJECT_DOMAIN}`) && PathPrefix(`${GROUPMANAGEMENT_BASE_HREF}`)"
        - "traefik.http.services.yti-groupmanagement.loadbalancer.server.port=9302"
        - "traefik.http.routers.yti-groupmanagement.entrypoints=web"
        - "traefik.http.routers.yti-groupmanagement.middlewares=groupmanagement-stripprefix,groupmanagement-redirect"
        - "traefik.http.middlewares.groupmanagement-stripprefix.stripprefix.prefixes=${GROUPMANAGEMENT_BASE_HREF}"
        - "traefik.http.middlewares.groupmanagement-redirect.redirectregex.regex=^(https?://[^/]+/[a-z0-9_-]+)$$"
        - "traefik.http.middlewares.groupmanagement-redirect.redirectregex.replacement=$${1}/"
        - "traefik.http.middlewares.groupmanagement-redirect.redirectregex.permanent=true"

  # CODELIST
  yti-codelist-ui:
    container_name: yti-codelist-ui
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.yti-codelist.rule=Host(`${PROJECT_DOMAIN}`) && PathPrefix(`${CODELIST_BASE_HREF}`)"
        - "traefik.http.services.yti-codelist.loadbalancer.server.port=80"
        - "traefik.http.routers.yti-codelist.entrypoints=web"
        - "traefik.http.routers.yti-codelist.middlewares=codelist-stripprefix,codelist-redirect"
        - "traefik.http.middlewares.codelist-stripprefix.stripprefix.prefixes=${CODELIST_BASE_HREF}"
        - "traefik.http.middlewares.codelist-redirect.redirectregex.regex=^(https?://[^/]+/[a-z0-9_-]+)$$"
        - "traefik.http.middlewares.codelist-redirect.redirectregex.replacement=$${1}/"
        - "traefik.http.middlewares.codelist-redirect.redirectregex.permanent=true"

  # TERMINOLOGY
  yti-terminology-ui:
    container_name: "yti-terminology-ui"
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.yti-terminology.rule=Host(`${PROJECT_DOMAIN}`) && PathPrefix(`${TERMINOLOGY_BASE_HREF}`)"
        - "traefik.http.services.yti-terminology.loadbalancer.server.port=80"
        - "traefik.http.routers.yti-terminology.entrypoints=web"
        - "traefik.http.routers.yti-terminology.middlewares=terminology-stripprefix,terminology-redirect"
        - "traefik.http.middlewares.terminology-stripprefix.stripprefix.prefixes=${TERMINOLOGY_BASE_HREF}"
        - "traefik.http.middlewares.terminology-redirect.redirectregex.regex=^(https?://[^/]+/[a-z0-9_-]+)$$"
        - "traefik.http.middlewares.terminology-redirect.redirectregex.replacement=$${1}/"
        - "traefik.http.middlewares.terminology-redirect.redirectregex.permanent=true"

  # DATAMODEL
  yti-datamodel-ui:
    container_name: "yti-datamodel-ui"
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.yti-datamodel.rule=Host(`${PROJECT_DOMAIN}`) && PathPrefix(`${DATAMODEL_BASE_HREF}`)"
        - "traefik.http.services.yti-datamodel.loadbalancer.server.port=80"
        - "traefik.http.routers.yti-datamodel.entrypoints=web"
        - "traefik.http.routers.yti-datamodel.middlewares=datamodel-stripprefix,datamodel-redirect"
        - "traefik.http.middlewares.datamodel-stripprefix.stripprefix.prefixes=${DATAMODEL_BASE_HREF}"
        - "traefik.http.middlewares.datamodel-redirect.redirectregex.regex=^(https?://[^/]+/[a-z0-9_-]+)$$"
        - "traefik.http.middlewares.datamodel-redirect.redirectregex.replacement=$${1}/"
        - "traefik.http.middlewares.datamodel-redirect.redirectregex.permanent=true"

  # COMMENTS
  yti-comments-ui:
    container_name: "yti-comments-ui"
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.yti-comments-ui.rule=Host(`${PROJECT_DOMAIN}`) && PathPrefix(`${COMMENTS_BASE_HREF}`)"
        - "traefik.http.services.yti-comments-ui.loadbalancer.server.port=80"
        - "traefik.http.routers.yti-comments-ui.entrypoints=web"
        - "traefik.http.routers.yti-comments-ui.middlewares=comments-stripprefix,comments-redirect"
        - "traefik.http.middlewares.comments-stripprefix.stripprefix.prefixes=${COMMENTS_BASE_HREF}"
        - "traefik.http.middlewares.comments-redirect.redirectregex.regex=^(https?://[^/]+/[a-z0-9_-]+)$$"
        - "traefik.http.middlewares.comments-redirect.redirectregex.replacement=$${1}/"
        - "traefik.http.middlewares.comments-redirect.redirectregex.permanent=true"
